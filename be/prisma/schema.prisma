// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

model Router {
  id            String  @id @default(uuid())
  name          String
  host          String
  port          Int     @default(8728)
  username      String
  password      String
  isActive      Boolean @default(true)
  isolirProfile String? // Profile name to use when isolating users

  // Owner - each router belongs to a user
  userId String?
  owner  user?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Telegram Notification Config per Router
  telegramBotToken String?
  telegramChatId   String?

  lastSync DateTime?

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  pppUsers  PPPUser[]
  odps      ODP[]
  odpCables ODPCable[]
}

// Track PPP users with accumulated usage
model PPPUser {
  id                 String         @id @default(uuid())
  routerId           String
  secretName         String
  comment            String?
  originalProfile    String? // Stores the original profile before isolation
  accumulatedTxBytes BigInt         @default(0)
  accumulatedRxBytes BigInt         @default(0)
  currentTxBytes     BigInt         @default(0)
  currentRxBytes     BigInt         @default(0)
  isOnline           Boolean        @default(false)
  lastSeenOnline     DateTime?
  latitude           Float?
  longitude          Float?
  odpId              String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  router             Router         @relation(fields: [routerId], references: [id], onDelete: Cascade)
  odp                ODP?           @relation(fields: [odpId], references: [id], onDelete: SetNull)
  usageHistory       UsageHistory[]

  @@unique([routerId, secretName])
}

// ODP (Optical Distribution Point) for fiber network mapping
model ODP {
  id         String     @id @default(uuid())
  routerId   String
  name       String
  latitude   Float
  longitude  Float
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  router     Router     @relation(fields: [routerId], references: [id], onDelete: Cascade)
  users      PPPUser[]
  cablesFrom ODPCable[] @relation("CableFrom")
  cablesTo   ODPCable[] @relation("CableTo")
}

// Cable connections between ODPs
model ODPCable {
  id        String   @id @default(uuid())
  routerId  String
  fromOdpId String
  toOdpId   String
  label     String?
  waypoints String? // JSON array of [lat, lng] pairs for cable bending
  createdAt DateTime @default(now())
  router    Router   @relation(fields: [routerId], references: [id], onDelete: Cascade)
  fromOdp   ODP      @relation("CableFrom", fields: [fromOdpId], references: [id], onDelete: Cascade)
  toOdp     ODP      @relation("CableTo", fields: [toOdpId], references: [id], onDelete: Cascade)
}

// History of each session's usage (saved when user disconnects)
model UsageHistory {
  id         String   @id @default(uuid())
  pppUserId  String
  txBytes    BigInt
  rxBytes    BigInt
  sessionEnd DateTime @default(now())
  pppUser    PPPUser  @relation(fields: [pppUserId], references: [id], onDelete: Cascade)
}

// ============================================================
// BetterAuth Models
// ============================================================

model user {
  id            String    @id
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  role          String?   @default("user")
  sessions      session[]
  accounts      account[]
  routers       Router[]
}

model session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      user     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  user      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt
}
